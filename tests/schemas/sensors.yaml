# region MALWARE
BaseFileMalwareDataModel: &BaseFileMalware
  type: object
  properties:
    '@class': { const: .BaseFileMalwareDataModel }
    type: { enum: [ KnownMalware, UnknownMalware, ApplicationControlMalware ] }
    detectionName: { type: [ string, 'null' ] }  # TODO: null depends on type?
    filePath: { type: string }

FilelessMalwareDataModel: &FilelessMalware
  type: object
  properties:
    '@class': { const: .FilelessMalwareDataModel }
    processName: { type: string }
    url:
      anyOf: [ { type: string, format: uri }, { type: 'null'} ]
    detectionRule: { type: [ string, 'null' ]}
    module: { type: [ string, 'null' ]}
    description: { type: [ string, 'null' ]}

malware_alerts:
  type: array
  items:
    type: object
    properties:
      guid: { type: string}
      timestamp: { type: integer }
      name: { type: string }
      type: { type: string }
      elementType: { type: string }
      machineName: { type: string }
      status: { type: string }
      needsAttention: { type: boolean }
      referenceGuid: { type: string }
      referenceElementType: { type: string }
      score: { type: [ number, 'null' ] }  # TODO: nulls only in FilelessMalware ?
      detectionValue: { type: [ string, 'null' ] }  # ditto ^
      detectionValueType: { type: [ string, 'null' ] }  # ditto ^
      detectionEngine: { type: string }
      malwareDataModel: { oneOf: [ *BaseFileMalware, *FilelessMalware ] }
      id:
        type: object
        properties:
          guid: { type: string }
          timestamp: { type: integer }
          malwareType: { type: string }
          elementType: { type: string }
      schedulerScan: { type: boolean }
# endregion

# region POLICIES
FileExclusion: &FileExclusion
  type: object
  properties:
    dataHash: { type: string, pattern: '^[0-9a-f]{64}$' }
    file: { type: string }
    modifiedBy: { type: string, format: email }
    lastModified: { type: integer }
    description: { type: string }

RegistryInclusion: &RegistryInclusion
  type: object
  properties:
    dataHash: { type: string, pattern: '^[0-9a-f]{64}$' }
    key: { type: string }
    values: { type: array, items: { type: string } }
    modifiedBy:
      anyOf:
      - { type: string, format: email }
      - { const: Cybereason }
    lastModified: { type: integer }
    description: { type: string }
    depth: { type: boolean }

policies:
  type: array
  items:
    type: object
    properties:
      metadata:
        type: object
        properties:
          id: { type: string, format: uuid }
          name: { type: string }
          description: { type: string }
          createdBy: { anyOf: [ { type: string, format: email }, { const: Admin } ] }
          creationTime: { type: integer }
          lastEditedBy: { anyOf: [ { type: string, format: email }, { const: '' } ] }
          lastEditedTime: { type: integer }
          assignedSensors: { type: integer }
          isDefault: { type: boolean }
          nonCompliantSensors: { type: integer }
          assignedGroupIds: { type: array, items: { type: string } }
          groupId: { type: string }
      configuration:
        type: object  # TODO: objects without properties
        properties:
          nameDescription:
            type: object
            properties:
              name: { type: string }
              description: { type: string }
              notes: { type: string }
              groupId: { type: string }
          antiMalware:
            type: object
            properties:
              enabled: { type: boolean }
              signatureMode: { enum: [ BLOCK, DETECT, DISABLED ] }
              documentProtectionMode: { enum: [ DETECT, DISABLED, PREVENT ] }
              documentProtectionSensitivityLevel: { enum: [ CAUTIOUS, MODERATE ] }
              documentProtectionExclusions: { type: array }  # TODO
              detectMode: { enum: [ 1, 2, 3 ] }
              preventMode: { enum: [ 1, 2 ] }
              quarantineMaliciousFiles: { type: boolean }
              scanDllFiles: { type: boolean }
              signerAllowlist: { type: array }  # TODO
              exclusions: { type: array, items: *FileExclusion }
              quickScanEnabled: { type: boolean }
              quickScan: { type: object }  # TODO
              quickScanMode: { enum: [ SCAN, SKIP ] }
              fullScanEnabled: { type: boolean }
              fullScan: { type: object }  # TODO (like quickScan)
              fullScanMode: { enum: [ SCAN, SKIP ] }
              localUpdateServerUrl: { const: '' }
              updateFrequencyIntervalMin: { type: integer }
              limitFileExtensions: { type: boolean }
              ignoreNetworkPaths: { type: boolean }
              scanArchives: { type: boolean }
              disableUSNJournaling: { type: boolean }
              documentProtectionAIStatus: { enum: [ DISABLED ] }
              documentProtectionAIMode: { enum: [ CAUTIOUS ] }
              documentProtectionAIExclusions: { type: array } # TODO
              variantFilePreventionMode: { enum: [ VFP_MODE_DISABLED ] }
              variantFilePreventionRuleIdExclusion: { type: array } # TODO
          powershellProtection:  # TODO
            type: object
            additionalProperties: true
            properties:
              enabled: { type: boolean }
              urlAndDomainExclusions: { type: array, items: *FileExclusion }
              processExclusions: { type: array, items: *FileExclusion }
          antiRansomware:  # TODO
            type: object
            additionalProperties: true
            properties:
              processEnablers:
                type: array
                items:
                  type: object
                  properties:
                    processName: { type: string }
                    enabled: { type: boolean }
          appControl:
            type: object
            properties:
              enabled: { type: boolean }
          collectionFeatures:  # TODO
            type: object
            additionalProperties: true
            properties:
              registryEventsEnabled: { type: boolean }
              registryEventsV2Enabled: { type: boolean }
              registryEventsInclusions: { type: array, items: *RegistryInclusion }
          endpointUiSettings: { type: object }
          endpointProtection: { type: object }
          antiExploit:
            type: object
            properties:
              enabled: { type: boolean }
              antiExploitMode: { enum: [ CAUTIOUS, EXISTING ] }
              antiExploitExclusions:
                type: array
                items:
                  type: object
                  properties:
                    dataHash: { type: string }
                    description: { type: string }
                    lastModified: { type: integer }
                    modifiedBy: { type: string, format: email }
                    processName: { type: string }
          advancedFlags:
            type: object
            properties:
              enabled: { type: boolean }
              flagValues: { type: array, items: { type: string }}
          response:
            type: object
            properties:
              enabled: { type: boolean }
          cms: { type: object }
          infrastructure:
            type: object
            properties:
              selfProtectEnabled: { type: boolean }
          rulesEngine:
            type: object
            properties:
              rulesEngineMode: { enum: [ DETECT, DISABLED, PREVENT ] }
              pathExclusions:
                type: array
                items:
                  type: object
                  properties:
                    dataHash: { type: string }
                    description: { type: string }
                    item: { type: string }
                    lastModified: { type: integer }
                    modifiedBy: { type: string, format: email }
              rulesIdExclusions: { type: array, items: { type: object }}
              bsaMode: { enum: [ DETECT, DISABLED, PREVENT ] }
          arw:
            type: object
            properties:
              mode: { enum: [ DISABLED ] }
              level: { enum: [ MODERATE ] }
              mbrEnabled: { type: boolean }
              vssEnabled: { type: boolean }
              autoRestoreEnabled: { type: boolean }
              allowlist: { type: array }
              customShadowCopyEnabled: { type: boolean }
              maxDiscSpace: { type: integer }
              drives: { type: array }
              allDrivesEnabled: { type: boolean }
          certificateExclusions:
            type: object
            properties:
              certificateExclusions: { type: array }
# endregion

# region SENSORS
sensors:
  type: array
  items:
    type: object
    properties:
      sensorId: { type: string }
      pylumId: { type: string }
      guid: { oneOf: [ *CrGuid, { const: '' } ]}
      fqdn:
        anyOf:
          - { type: string, format: idn-hostname }
          - { const: '' }
      machineName: { type: string }
      internalIpAddress: { type: string, format: ipv4 }
      externalIpAddress: { type: string, format: ipv4 }
      siteName: { type: string }
      siteId: { type: integer }
      ransomwareStatus: { enum: [ DETECT_AND_SUSPEND, DETECT_ONLY, DETECT_SUSPEND_PREVENT, DISABLED, UNKNOWN ] }
      preventionStatus: { enum: [ NOT_INSTALLED, DISABLED, ENABLED, UNKNOWN ] }
      isolated: { type: boolean }
      disconnectionTime: { type: integer }
      lastPylumInfoMsgUpdateTime: { type: integer }
      lastPylumUpdateTimestampMs: { type: integer }
      status: { enum: [ Archived, Stale, Online, Offline ] }
      serviceStatus: { enum: [ Down, Up ] }
      onlineTimeMS: { type: integer }
      offlineTimeMS: { type: integer }
      staleTimeMS: { type: integer }
      archiveTimeMs: { type: [ integer, 'null' ] }
      statusTimeMS: { type: integer }
      lastStatusAction: { enum: [ Archive, None ] }
      archivedOrUnarchiveComment: { type: [ string, 'null' ] }
      sensorArchivedByUser: { type: [ string, 'null' ] }
      serverName: { type: string }
      serverId: { type: string, pattern: '^[0-9a-f]{24}$' }
      serverIp: { type: string, format: ipv4 }
      privateServerIp: { type: string, format: ipv4 }
      collectiveUuid: { type: string, format: uuid }
      osType: { enum: [ LINUX, OSX, WINDOWS, UNKNOWN_OS ] }
      osVersionType: { type: string }
      collectionStatus: { enum: [ DISABLED, ADVANCED, ENABLED, SUSPENDED ] }
      version: { type: string }
      consoleVersion: { type: [ string, 'null' ] }
      firstSeenTime: { type: integer }
      upTime: { type: integer }
      cpuUsage: { type: number }
      memoryUsage: { type: integer }
      outdated: { type: boolean }
      amStatus: { enum: [ AM_BLOCK, AM_DETECT_DISINFECT, AM_DETECT_ONLY, AM_FIRST_TIME_INITIALIZATION, AM_PRIOR_AV_ERROR, AM_UNINSTALLED, AM_UNKNOWN_ERROR, UNKNOWN ] }
      amModeOrigin: { type: [ string, 'null' ] }
      avDbVersion: { type: string }
      avDbLastUpdateTime: { type: integer }
      powerShellStatus: { enum: [ '', PS_DISABLED, PS_ENABLED ] }
      bepMode: { enum: [ '', BEP_DISABLED, BEP_PREVENT, BEP_DETECT ] }
      vppMode: { enum: [ '', VPP_PREVENT, VPP_DETECT, VPP_DISABLED ] }
      remoteShellStatus: { enum: [ AC_ENABLED, AC_DISABLED ] }
      usbStatus: { enum: [ DISABLED ] }
      fwStatus: { enum: [ DISABLED ] }
      antiExploitStatus: { enum: [ '', AE_CAUTIOUS, AE_DISABLED, AE_ENABLED, AE_UNKNOWN ] }
      documentProtectionStatus: { enum: [ '', DS_DETECT, DS_DISABLED, DS_PREVENT, DS_UNKNOWN ] }
      documentProtectionMode: { enum: [ '', DM_CAUTIOUS, DM_MODERATE, DM_UNKNOWN ] }
      serialNumber: { type: string }
      deviceModel: { type: string }
      organizationalUnit: { type: string }
      variantFilePreventionMode: { enum: [ '', VFP_M_UNKNOWN, VFP_M_DISABLED ] }
      antiMalwareStatus: { enum: [ '', AM_ENABLED, AM_DISABLED ] }
      antiMalwareModeOrigin: { enum: [ SET_BY_POLICY, null ]}
      organization: { type: string }
      proxyAddress: { type: string }
      preventionError: { enum: [ '', BLOCKI_GENERAL_ERROR ] }
      exitReason: { enum: [ STOP_REQUEST_FROM_PYLUM ] }
      actionsInProgress: { type: integer }
      pendingActions: { type: array }  # TODO
      lastUpgradeResult: { enum: [ AlreadyUpdated, Failed, InvalidCertificate, NewPackageDownloaded, None, Succeeded, Uninstalled ] }
      department: { type: [ string, 'null' ] }
      location: { type: [ string, 'null' ] }
      criticalAsset: { type: [ boolean, 'null' ] }
      deviceType: { type: [ string, 'null' ] }
      customTags: { type: [ string, 'null' ] }
      lastUpgradeSteps:
        type: array
        items:
          type: object
          properties:
            name: { enum: [AlreadyUpdated, Failed, InProgress, InvalidCertificate, MsiSendFail, NewPackageDownloaded, SendingMsi, Started, Succeeded, Uninstalled ] }
            startTime: { type: integer }
      disconnected: { type: boolean }
      staticAnalysisDetectMode: { enum: [ CAUTIOUS, DISABLED, MODERATE, UNKNOWN ] }
      staticAnalysisDetectModeOrigin: { enum: [ AWAITING_UPDATE, null ] }
      staticAnalysisPreventMode: { enum: [ CAUTIOUS, DISABLED, UNKNOWN ] }
      staticAnalysisPreventModeOrigin: { enum: [ AWAITING_UPDATE, null ] }
      collectionComponents: { type: array, items: { enum: [ DPI, Metadata, File Events, Registry Events ] }}
      sensorLastUpdate: { type: integer }
      fullScanStatus: { enum: [ IN_PROGRESS, IDLE, UNKNOWN ] }
      quickScanStatus: { enum: [ IN_PROGRESS, IDLE, UNKNOWN ] }
      lastFullScheduleScanSuccessTime: { type: integer }
      lastQuickScheduleScanSuccessTime: { type: integer }
      policyName: { type: string }
      deliveryTime: { type: integer }
      policyId:
        oneOf:
          - { type: string, format: uuid }
          - { type: 'null' }
      compliance: { type: [ boolean, 'null' ] }
      groupId: { type: string, format: uuid }
      groupName: { type: string }
      groupStickiness: { type: boolean }
      purgedSensors: { type: boolean }
      sensorPurgedByUser: { type: [ string, 'null' ] }
      purgeTimestamp: { type: [ integer, 'null' ] }
      decommissionedSensors: { type: boolean }
      decommissionedByUser: { type: [ string, 'null' ] }
      decommissionTimestamp: { type: [ integer, 'null' ] }
      groupStickinessLabel: { enum: [ Dynamic, Manual ] }
# endregion

# region GROUPS
group: &group
  type: object
  properties:
    id: { type: string, format: uuid }
    name: { type: string }
    description: { type: string }
    creationTime: { type: integer }
    lastUpdateTime: { type: integer }
    updatedByUser:
      anyOf:
        - { type: string, format: email }
        - { const: 'Admin' }
    groupAssignRule:
      oneOf:
        - { type: 'null' }
        - type: object
          properties:  # TODO
            ruleType: { enum: [ externalIpAddress, machineName, organization, organizationalUnit ] }
            ruleOperator: { enum: [ ContainsIgnoreCase, EqualsIgnoreCase ]}
            ruleValues: { type: array, items: { type: string }}
    policyId:
      anyOf:
        - { type: string, format: uuid }
        - { const: '' }
    priority: { type: [ 'null', integer ] }

groups:
  type: array
  items: *group
# endregion
